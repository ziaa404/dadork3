
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة طلاب الصف الأول الابتدائي - مدارس البشرى</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            direction: rtl;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1.5" fill="rgba(255,255,255,0.05)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.08)"/><circle cx="10" cy="60" r="1" fill="rgba(255,255,255,0.03)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .header h2 {
            font-size: 1.5rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .auth-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .google-signin-btn {
            background: linear-gradient(45deg, #4285f4, #34a853);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 8px 25px rgba(66, 133, 244, 0.3);
            position: relative;
            overflow: hidden;
        }

        .google-signin-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .google-signin-btn:hover::before {
            left: 100%;
        }

        .google-signin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(66, 133, 244, 0.4);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .teacher-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .teacher-input {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .teacher-input label {
            font-weight: bold;
            font-size: 1.3rem;
            color: #333;
            min-width: 120px;
        }

        .teacher-input input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .teacher-input input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .student-management {
            margin-bottom: 30px;
        }

        .management-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-add {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-add:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.4);
        }

        .btn-subject {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-subject:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-export {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-export:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }

        .filter-select {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .student-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.4s ease;
            position: relative;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .student-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .student-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .delete-student-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-student-btn:hover {
            background: #ff3742;
            transform: scale(1.1);
        }

        .progress-bars {
            margin: 20px 0;
        }

        .progress-item {
            margin-bottom: 15px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.8s ease;
        }

        .progress-reading {
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .progress-writing {
            background: linear-gradient(90deg, #f093fb, #f5576c);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 40px;
            border-radius: 25px;
            width: 95%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.4s ease;
        }

        @keyframes slideInUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            color: #000;
            background: #f0f0f0;
        }

        .skill-section {
            margin-bottom: 30px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .skill-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .skill-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .skill-name {
            font-weight: 500;
            color: #333;
            font-size: 1.1rem;
        }

        .skill-buttons {
            display: flex;
            gap: 10px;
        }

        .skill-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .skill-btn.mastered {
            background: #4CAF50;
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .skill-btn.not-mastered {
            background: #f44336;
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .skill-btn:hover {
            transform: scale(1.05);
        }

        .progress-summary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .progress-summary h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .chart-container {
            margin-top: 30px;
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .notification.success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .notification.info {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }

        .form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.2);
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-share {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }

        .btn-share:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .management-buttons {
                flex-direction: column;
            }
            
            .students-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .modal-content {
                width: 98%;
                margin: 5% auto;
                padding: 25px;
            }

            .search-filter {
                flex-direction: column;
            }

            .stats-overview {
                grid-template-columns: 1fr 1fr;
            }

            .teacher-input {
                flex-direction: column;
                align-items: stretch;
            }

            .teacher-input label {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 نظام متابعة طلاب الصف الأول الابتدائي</h1>
            <h2>مدارس البشرى - النظام المتطور</h2>
        </div>

        <div class="auth-section" id="authSection">
            <h3>مرحباً بك في النظام المحسن</h3>
            <p>يرجى تسجيل الدخول للوصول إلى جميع الميزات المتقدمة</p>
            <button class="google-signin-btn" onclick="simulateGoogleLogin()">
                <span class="loading hidden" id="loginLoading"></span>
                📧 تسجيل الدخول بـ Google
            </button>
        </div>

        <div class="main-content hidden" id="mainContent">
            <div class="teacher-section">
                <div class="teacher-input">
                    <label for="teacherName">اسم المعلم:</label>
                    <input type="text" id="teacherName" placeholder="أدخل اسم المعلم" onchange="saveTeacherName()">
                </div>
            </div>

            <div class="stats-overview" id="statsOverview">
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">إجمالي الطلاب</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgReading">0%</div>
                    <div class="stat-label">متوسط القراءة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgWriting">0%</div>
                    <div class="stat-label">متوسط الكتابة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="excellentStudents">0</div>
                    <div class="stat-label">الطلاب المتفوقون</div>
                </div>
            </div>

            <div class="student-management">
                <div class="management-buttons">
                    <button class="btn btn-add" onclick="addStudent()">➕ إضافة طالب</button>
                    <button class="btn btn-subject" onclick="showLanguageSubject()">📚 عرض التقارير</button>
                    <button class="btn btn-export" onclick="exportAllData()">📤 تصدير البيانات</button>
                </div>

                <div class="search-filter">
                    <input type="text" class="search-input" id="searchInput" placeholder="🔍 البحث عن طالب..." onkeyup="filterStudents()">
                    <select class="filter-select" id="progressFilter" onchange="filterStudents()">
                        <option value="all">جميع الطلاب</option>
                        <option value="excellent">المتفوقون (90%+)</option>
                        <option value="good">جيد (70-89%)</option>
                        <option value="needs-improvement">يحتاج تحسين (<70%)</option>
                    </select>
                </div>
            </div>

            <div class="students-grid" id="studentsGrid">
                <!-- طلاب سيتم إضافتهم هنا -->
            </div>

            <div class="chart-container" id="chartContainer" style="display: none;">
                <h3>📊 التحليل الشامل لمستوى الطلاب</h3>
                <canvas id="progressChart"></canvas>
                <div class="share-buttons">
                    <button class="btn-share" onclick="shareChart()">📊 مشاركة الرسم البياني</button>
                    <button class="btn-share" onclick="shareDetailedReport()">📋 التقرير المفصل</button>
                    <button class="btn-share" onclick="generatePrintableReport()">🖨️ تقرير للطباعة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة طالب -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddStudentModal()">&times;</span>
            <h2>إضافة طالب جديد</h2>
            <div class="form-group">
                <label for="studentName">اسم الطالب:</label>
                <input type="text" id="studentName" placeholder="أدخل اسم الطالب كاملاً">
            </div>
            <div class="form-group">
                <label for="studentId">رقم الطالب (اختياري):</label>
                <input type="text" id="studentId" placeholder="رقم الطالب">
            </div>
            <button class="btn btn-add" onclick="saveStudent()">💾 حفظ الطالب</button>
        </div>
    </div>

    <!-- نافذة تقييم لغتي -->
    <div id="languageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLanguageModal()">&times;</span>
            <h2 id="languageModalTitle">تقييم مادة لغتي</h2>
            
            <div class="progress-summary" id="progressSummary">
                <h3>📈 ملخص التقدم</h3>
                <p id="progressText">القراءة: 0/12 | الكتابة: 0/12</p>
            </div>

            <div class="skill-section">
                <div class="skill-title">📖 مهارات القراءة</div>
                <div id="readingSkills">
                    <!-- مهارات القراءة -->
                </div>
            </div>

            <div class="skill-section">
                <div class="skill-title">✍️ مهارات الكتابة</div>
                <div id="writingSkills">
                    <!-- مهارات الكتابة -->
                </div>
            </div>

            <div class="chart-container">
                <h3>📊 الرسم البياني للطالب</h3>
                <canvas id="studentChart"></canvas>
                <div class="share-buttons">
                    <button class="btn-share" onclick="shareStudentProgress()">📤 إرسال للولي</button>
                    <button class="btn-share" onclick="generateStudentCertificate()">🏆 شهادة تقدير</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // بيانات الطلاب والإعدادات
        let students = [];
        let filteredStudents = [];
        let currentStudentId = null;
        let isLoggedIn = false;
        let userEmail = '';
        let charts = {};

        // مهارات القراءة والكتابة المحدثة
        const readingSkills = [
            'التعرف على الحروف الهجائية',
            'الحروف بحركة الفتح',
            'الحروف بحركة الكسر',
            'الحروف بحركة الضم',
            'سرعة الأداء في قراءة الحروف',
            'قراءة كلمات ثلاثية بسيطة',
            'المد بالألف والواو والياء',
            'السكون وعلامته',
            'اللام القمرية',
            'الشدة',
            'اللام الشمسية',
            'التنوين'
        ];

        const writingSkills = [
            'التعرف على الحروف',
            'الحروف بحركة الفتح',
            'الحروف بحركة الكسر والضم',
            'سرعة الأداء في الحروف',
            'كتابة كلمات ثلاثية',
            'المد بالألف والواو والياء',
            'السكون',
            'اللام القمرية',
            'الشدة',
            'اللام الشمسية',
            'التنوين',
            'التاء المربوطة'
        ];

        // تحميل البيانات عند بدء التشغيل
        window.onload = function() {
            loadData();
        };

        // محاكاة تسجيل الدخول بـ Google
        function simulateGoogleLogin() {
            // في التطبيق الحقيقي، هذا سيكون تكامل مع Google OAuth
            userEmail = 'teacher@albushra.edu.sa';
            isLoggedIn = true;
            
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            loadData();
            alert('تم تسجيل الدخول بنجاح!');
        }

        // حفظ اسم المعلم
        function saveTeacherName() {
            const teacherName = document.getElementById('teacherName').value;
            localStorage.setItem('teacherName', teacherName);
        }

        // إضافة طالب جديد
        function addStudent() {
            document.getElementById('addStudentModal').style.display = 'block';
        }

        function closeAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'none';
            document.getElementById('studentName').value = '';
        }

        function saveStudent() {
            const name = document.getElementById('studentName').value.trim();
            if (!name) {
                alert('يرجى إدخال اسم الطالب');
                return;
            }

            const student = {
                id: Date.now(),
                name: name,
                readingSkills: {},
                writingSkills: {}
            };

            // تهيئة المهارات
            readingSkills.forEach(skill => {
                student.readingSkills[skill] = false;
            });

            writingSkills.forEach(skill => {
                student.writingSkills[skill] = false;
            });

            students.push(student);
            saveData();
            renderStudents();
            closeAddStudentModal();
        }

        // عرض الطلاب
        function renderStudents() {
            const grid = document.getElementById('studentsGrid');
            grid.innerHTML = '';

            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                
                const readingProgress = calculateProgress(student.readingSkills);
                const writingProgress = calculateProgress(student.writingSkills);
                const totalProgress = Math.round((readingProgress + writingProgress) / 2);

                card.innerHTML = `
                    <button class="delete-student-btn" onclick="deleteStudent(${student.id})" title="حذف الطالب">×</button>
                    <div class="student-name">${student.name}</div>
                    <div class="progress-summary">
                        <h3>التقدم العام: ${totalProgress}%</h3>
                        <p>القراءة: ${readingProgress}% | الكتابة: ${writingProgress}%</p>
                    </div>
                    <button class="btn btn-subject" onclick="openLanguageAssessment(${student.id})">تقييم لغتي</button>
                `;

                grid.appendChild(card);
            });
        }

        // حساب نسبة التقدم
        function calculateProgress(skills) {
            const total = Object.keys(skills).length;
            const mastered = Object.values(skills).filter(skill => skill).length;
            return total > 0 ? Math.round((mastered / total) * 100) : 0;
        }

        // حذف طالب
        function deleteStudent(studentId) {
            if (confirm('هل أنت متأكد من حذف هذا الطالب؟')) {
                students = students.filter(student => student.id !== studentId);
                saveData();
                renderStudents();
            }
        }

        // فتح تقييم لغتي
        function openLanguageAssessment(studentId) {
            currentStudentId = studentId;
            const student = students.find(s => s.id === studentId);
            
            document.getElementById('languageModalTitle').textContent = `تقييم مادة لغتي - ${student.name}`;
            
            renderSkills();
            updateProgressSummary();
            document.getElementById('languageModal').style.display = 'block';
            
            // رسم الرسم البياني للطالب
            setTimeout(() => renderStudentChart(student), 100);
        }

        function closeLanguageModal() {
            document.getElementById('languageModal').style.display = 'none';
            currentStudentId = null;
        }

        // عرض المهارات
        function renderSkills() {
            const student = students.find(s => s.id === currentStudentId);
            
            // مهارات القراءة
            const readingContainer = document.getElementById('readingSkills');
            readingContainer.innerHTML = '';
            
            readingSkills.forEach(skill => {
                const skillDiv = document.createElement('div');
                skillDiv.className = 'skill-item';
                
                const mastered = student.readingSkills[skill];
                
                skillDiv.innerHTML = `
                    <span class="skill-name">${skill}</span>
                    <div class="skill-buttons">
                        <button class="skill-btn ${mastered ? 'mastered' : ''}" onclick="updateSkill('reading', '${skill}', true)">أتقن</button>
                        <button class="skill-btn ${!mastered ? 'not-mastered' : ''}" onclick="updateSkill('reading', '${skill}', false)">لم يتقن</button>
                    </div>
                `;
                
                readingContainer.appendChild(skillDiv);
            });

            // مهارات الكتابة
            const writingContainer = document.getElementById('writingSkills');
            writingContainer.innerHTML = '';
            
            writingSkills.forEach(skill => {
                const skillDiv = document.createElement('div');
                skillDiv.className = 'skill-item';
                
                const mastered = student.writingSkills[skill];
                
                skillDiv.innerHTML = `
                    <span class="skill-name">${skill}</span>
                    <div class="skill-buttons">
                        <button class="skill-btn ${mastered ? 'mastered' : ''}" onclick="updateSkill('writing', '${skill}', true)">أتقن</button>
                        <button class="skill-btn ${!mastered ? 'not-mastered' : ''}" onclick="updateSkill('writing', '${skill}', false)">لم يتقن</button>
                    </div>
                `;
                
                writingContainer.appendChild(skillDiv);
            });
        }

        // تحديث المهارة
        function updateSkill(type, skill, mastered) {
            const student = students.find(s => s.id === currentStudentId);
            
            if (type === 'reading') {
                student.readingSkills[skill] = mastered;
            } else {
                student.writingSkills[skill] = mastered;
            }
            
            saveData();
            renderSkills();
            updateProgressSummary();
            renderStudents();
            
            // تحديث الرسم البياني
            setTimeout(() => renderStudentChart(student), 100);
        }

        // تحديث ملخص التقدم
        function updateProgressSummary() {
            const student = students.find(s => s.id === currentStudentId);
            const readingProgress = calculateProgress(student.readingSkills);
            const writingProgress = calculateProgress(student.writingSkills);
            
            document.getElementById('progressText').textContent = 
                `القراءة: ${readingProgress}% (${Object.values(student.readingSkills).filter(Boolean).length}/${readingSkills.length}) | الكتابة: ${writingProgress}% (${Object.values(student.writingSkills).filter(Boolean).length}/${writingSkills.length})`;
        }

        // رسم الرسم البياني للطالب
        function renderStudentChart(student) {
            const ctx = document.getElementById('studentChart').getContext('2d');
            
            const readingProgress = calculateProgress(student.readingSkills);
            const writingProgress = calculateProgress(student.writingSkills);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['القراءة', 'الكتابة'],
                    datasets: [{
                        data: [readingProgress, writingProgress],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)'
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(118, 75, 162, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: `تقدم الطالب: ${student.name}`
                        }
                    }
                }
            });
        }

        // عرض موضوع لغتي
        function showLanguageSubject() {
            if (students.length === 0) {
                alert('يرجى إضافة طلاب أولاً');
                return;
            }
            
            renderOverallChart();
            document.getElementById('chartContainer').style.display = 'block';
        }

        // رسم الرسم البياني العام
        function renderOverallChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            const studentNames = students.map(s => s.name);
            const readingData = students.map(s => calculateProgress(s.readingSkills));
            const writingData = students.map(s => calculateProgress(s.writingSkills));
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: studentNames,
                    datasets: [
                        {
                            label: 'القراءة (%)',
                            data: readingData,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'الكتابة (%)',
                            data: writingData,
                            backgroundColor: 'rgba(118, 75, 162, 0.8)',
                            borderColor: 'rgba(118, 75, 162, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'تقدم جميع الطلاب في مادة لغتي'
                        }
                    }
                }
            });
        }

        // مشاركة الرسم البياني
        function shareChart() {
            const canvas = document.getElementById('progressChart');
            const imageData = canvas.toDataURL();
            
            // إنشاء تقرير مشاركة
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير تقدم الطلاب - مدارس البشرى</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .chart { text-align: center; margin: 20px 0; }
                        .print-btn { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>تقرير تقدم طلاب الصف الأول الابتدائي</h1>
                        <h2>مدارس البشرى</h2>
                        <p>اسم المعلم: ${document.getElementById('teacherName').value || 'غير محدد'}</p>
                        <p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                    </div>
                    <div class="chart">
                        <img src="${imageData}" alt="الرسم البياني لتقدم الطلاب" style="max-width: 100%; height: auto;">
                    </div>
                    <button class="print-btn" onclick="window.print()">طباعة التقرير</button>
                </body>
                </html>
            `);
        }

        // مشاركة التقرير التفصيلي
        function shareReport() {
            let reportContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>التقرير التفصيلي - مدارس البشرى</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .student { margin-bottom: 30px; border: 1px solid #ddd; padding: 20px; border-radius: 10px; }
                        .student-name { font-size: 1.5rem; font-weight: bold; color: #333; margin-bottom: 15px; }
                        .skills-section { margin-bottom: 20px; }
                        .skill-title { font-weight: bold; color: #667eea; margin-bottom: 10px; }
                        .skill-item { padding: 5px 0; }
                        .mastered { color: green; }
                        .not-mastered { color: red; }
                        .progress { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; }
                        .print-btn { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>التقرير التفصيلي لطلاب الصف الأول الابتدائي</h1>
                        <h2>مدارس البشرى</h2>
                        <p>اسم المعلم: ${document.getElementById('teacherName').value || 'غير محدد'}</p>
                        <p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                        <p>عدد الطلاب: ${students.length}</p>
                    </div>
                    <button class="print-btn" onclick="window.print()">طباعة التقرير</button>
            `;

            students.forEach(student => {
                const readingProgress = calculateProgress(student.readingSkills);
                const writingProgress = calculateProgress(student.writingSkills);
                
                reportContent += `
                    <div class="student">
                        <div class="student-name">${student.name}</div>
                        <div class="progress">
                            <strong>التقدم العام:</strong> القراءة ${readingProgress}% | الكتابة ${writingProgress}%
                        </div>
                        
                        <div class="skills-section">
                            <div class="skill-title">📖 مهارات القراءة:</div>
                `;
                
                readingSkills.forEach(skill => {
                    const mastered = student.readingSkills[skill];
                    reportContent += `
                        <div class="skill-item ${mastered ? 'mastered' : 'not-mastered'}">
                            ${skill}: ${mastered ? '✓ أتقن' : '✗ لم يتقن'}
                        </div>
                    `;
                });
                
                reportContent += `
                        </div>
                        <div class="skills-section">
                            <div class="skill-title">✍️ مهارات الكتابة:</div>
                `;
                
                writingSkills.forEach(skill => {
                    const mastered = student.writingSkills[skill];
                    reportContent += `
                        <div class="skill-item ${mastered ? 'mastered' : 'not-mastered'}">
                            ${skill}: ${mastered ? '✓ أتقن' : '✗ لم يتقن'}
                        </div>
                    `;
                });
                
                reportContent += `
                        </div>
                    </div>
                `;
            });

            reportContent += `
                </body>
                </html>
            `;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportContent);
        }

        // مشاركة تقدم طالب واحد
        function shareStudentProgress() {
            const student = students.find(s => s.id === currentStudentId);
            const canvas = document.getElementById('studentChart');
            const imageData = canvas.toDataURL();
            
            const readingProgress = calculateProgress(student.readingSkills);
            const writingProgress = calculateProgress(student.writingSkills);
            
            let reportContent = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير تقدم الطالب - ${student.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .student-info { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
                        .chart { text-align: center; margin: 20px 0; }
                        .skills-section { margin-bottom: 20px; }
                        .skill-title { font-weight: bold; color: #667eea; margin-bottom: 10px; }
                        .skill-item { padding: 5px 0; }
                        .mastered { color: green; }
                        .not-mastered { color: red; }
                        .print-btn { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>تقرير تقدم الطالب</h1>
                        <h2>مدارس البشرى - الصف الأول الابتدائي</h2>
                    </div>
                    
                    <div class="student-info">
                        <h2>اسم الطالب: ${student.name}</h2>
                        <p>اسم المعلم: ${document.getElementById('teacherName').value || 'غير محدد'}</p>
                        <p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                        <p><strong>التقدم العام:</strong> القراءة ${readingProgress}% | الكتابة ${writingProgress}%</p>
                    </div>
                    
                    <div class="chart">
                        <img src="${imageData}" alt="الرسم البياني لتقدم الطالب" style="max-width: 400px; height: auto;">
                    </div>
                    
                    <div class="skills-section">
                        <div class="skill-title">📖 مهارات القراءة:</div>
            `;
            
            readingSkills.forEach(skill => {
                const mastered = student.readingSkills[skill];
                reportContent += `
                    <div class="skill-item ${mastered ? 'mastered' : 'not-mastered'}">
                        ${skill}: ${mastered ? '✓ أتقن' : '✗ لم يتقن'}
                    </div>
                `;
            });
            
            reportContent += `
                    </div>
                    <div class="skills-section">
                        <div class="skill-title">✍️ مهارات الكتابة:</div>
            `;
            
            writingSkills.forEach(skill => {
                const mastered = student.writingSkills[skill];
                reportContent += `
                    <div class="skill-item ${mastered ? 'mastered' : 'not-mastered'}">
                        ${skill}: ${mastered ? '✓ أتقن' : '✗ لم يتقن'}
                    </div>
                `;
            });
            
            reportContent += `
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="print-btn" onclick="window.print()">طباعة التقرير</button>
                        <p style="margin-top: 20px; color: #666;">
                            هذا التقرير يمكن طباعته أو حفظه كـ PDF لإرساله لولي الأمر
                        </p>
                    </div>
                </body>
                </html>
            `;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportContent);
        }

        // حفظ البيانات
        function saveData() {
            if (isLoggedIn) {
                const data = {
                    students: students,
                    teacherName: document.getElementById('teacherName').value,
                    lastSaved: new Date().toISOString(),
                    userEmail: userEmail
                };
                
                // حفظ في localStorage (محاكاة قاعدة البيانات)
                localStorage.setItem('studentTrackingData', JSON.stringify(data));
                
                // إظهار رسالة حفظ تلقائي
                showSaveNotification();
            }
        }

        // تحميل البيانات
        function loadData() {
            const savedData = localStorage.getItem('studentTrackingData');
            if (savedData) {
                const data = JSON.parse(savedData);
                students = data.students || [];
                
                if (data.teacherName) {
                    document.getElementById('teacherName').value = data.teacherName;
                }
                
                renderStudents();
            }
        }

        // إظهار إشعار الحفظ التلقائي
        function showSaveNotification() {
            // إنشاء إشعار الحفظ
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 1001;
                font-weight: bold;
                animation: slideInRight 0.3s ease;
            `;
            notification.textContent = '✓ تم الحفظ تلقائياً';
            
            document.body.appendChild(notification);
            
            // إزالة الإشعار بعد 3 ثواني
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // إضافة CSS للأنيميشن
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // حفظ تلقائي كل 30 ثانية
        setInterval(() => {
            if (isLoggedIn && students.length > 0) {
                saveData();
            }
        }, 30000);

        // حفظ البيانات عند إغلاق الصفحة
        window.addEventListener('beforeunload', function() {
            if (isLoggedIn) {
                saveData();
            }
        });

        // إضافة بيانات تجريبية للعرض
        function addSampleData() {
            if (students.length === 0) {
                const sampleStudents = [
                    { name: 'أحمد محمد', id: 1001 },
                    { name: 'فاطمة علي', id: 1002 },
                    { name: 'محمد عبدالله', id: 1003 }
                ];

                sampleStudents.forEach(sampleStudent => {
                    const student = {
                        id: sampleStudent.id,
                        name: sampleStudent.name,
                        readingSkills: {},
                        writingSkills: {}
                    };

                    // تهيئة المهارات
                    readingSkills.forEach(skill => {
                        student.readingSkills[skill] = Math.random() > 0.5;
                    });

                    writingSkills.forEach(skill => {
                        student.writingSkills[skill] = Math.random() > 0.5;
                    });

                    students.push(student);
                });

                saveData();
                renderStudents();
            }
        }

        // تشغيل البيانات التجريبية عند تسجيل الدخول لأول مرة
        setTimeout(() => {
            if (isLoggedIn && students.length === 0) {
                addSampleData();
            }
        }, 1000);

    </script>
</body>
</html>
